{% extends "base.html" %}

{% block title %}YouPymp3 - Download Youtube mp3{% endblock title %}
 
{% block extra_head %}
  <style>
    .input-xxlarge {
      width: 600px  !important;
      height: 44px;
      margin-bottom: 10px !important;
      line-height: 30px !important;
      padding: 11px 19px !important;
      font-size: 17.5px !important;
    }

    .container-full {
      margin: 0 auto;
      width: 100%;
      min-height:100%;
      background-color:#ffFFFF;
      color:#6D1717;
      overflow:hidden;
    }

    .container-full a {
      color:#6D1717;
      text-decoration:none;
    }

    .input-group {
      width: 100% !important;
    }

    .media-object{
      height: 150px !important ;
      width: 150px !important;
    }

    .thumbnail {
      display: block;
      padding: 4px;
      line-height: 20px;
      border: 1px solid #ddd;
      width: 200px;
      height: 200px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
{% endblock extra_head %}

{% block content %}
<div class="container-full">
  <div class="row">
    <div class="col-md-offset-3 col-lg-6 text-center v-center">
      <h1>Video to mp3</h1>
      <p class="lead">Convert your favorite online videos to mp3 automatically.</p>
      
      <br><br>

      <form id="download_form" class="col-lg-12" action="#" method="POST">
        <div class="input-group" style="width:340px;text-align:center;margin:0 auto;">
          <input id="input_box" name="url" type="text" class="form-control input-lg" title="Copy and paste the videos url and press the OK button" placeholder="http://<type video url here>">
          <span class="input-group-btn">
            <!-- <button id="button_convert" type="submit" href="#" class="btn btn-success btn-lg"  rel="popover">Convert</button> -->
            <button id="button_check" type="submit" href="#" class="btn btn-primary btn-lg">Check</button>
          </span>
          <a href="#" id="to_replace"></a>
        </div>
      </form>
    </div> 
  </div> <!-- /row -->

  <div class="row">
    <br />
    <div id="message_div" class="col-lg-12 text-center v-center" style="font-size:20pt;">
        <div id="success_div" class='alert alert-success'>
            <a id="convert_button" href="{{ url_for('convert', uid='') }}"><button class='btn btn-primary btn-lg'><i class='icon-music'></i> convert</button></a>
            <a id="download_button" href="{{ url_for('download', uid='') }}"><button class='btn btn-primary btn-lg'><i class='icon-download'></i> download</button></a>
        </div>
        {% for error in error_list %}
            <div class="alert alert-danger">{{ error }}</div> 
        {% endfor %}

        <div id="progress_div" class="col-lg-2 col-md-offset-5 text-center v-center" style="font-size:20pt;">
            <div class="progress progress-striped active">
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                    <span class="sr-only">60% Complete</span>
                </div>
            </div>
        </div>

        <div id="audio_div" class="col-lg-12 text-center v-center">
            <video id="video_player" width="640" height="1" controls preload="auto">
                <source src="#" type="video/mp4">
            </video> 
            <audio controls preload="auto" width="640" height="264">  
                <source id="source_audio" src="#" type='#' />  
            </audio>
<!--         <video id="example_video_1" class="video-js vjs-default-skin" controls preload="none" width="640" height="264"
            poster="http://video-js.zencoder.com/oceans-clip.png"
            data-setup="{}">
            <source class="vsrc" src="#" type='video/mp4' /> -->
<!--             <source src="http://video-js.zencoder.com/oceans-clip.webm" type='video/webm' />
            <source src="http://video-js.zencoder.com/oceans-clip.ogv" type='video/ogg' /> -->
            <!-- <track kind="captions" src="demo.captions.vtt" srclang="en" label="English"></track> -->
<!--         </video> -->

        </div>
    </div>




  </div> <!-- /row -->
  <br>

  <div class="row">
    <div class="col-lg-12 text-center v-center" style="font-size:39pt;">
      <a href="#"><i class="icon-google-plus"></i></a> <a href="#"><i class="icon-facebook"></i></a>  <a href="#"><i class="icon-twitter"></i></a> <a href="#"><i class="icon-github"></i></a> <a href="#"><i class="icon-pinterest"></i></a>
    </div>
  </div> <!-- /row -->

  <br><br><br><br><br>

</div> <!-- /container full -->

<div class="container">
  <hr>  
  <div class="row">
    <div class="col-lg-12">
      <br><br>
      <p class="text-center">Built by <a href="http://www.github.com/marcwebbie">@Marcwebbie</a>&nbsp; Â©Copyright 2013 </p>
      <br><br>
    </div>
  </div>
</div>
{% endblock content %}


{% block scripts %}
<script>
    function get_initial_state() {
        $('#input_box').val();
        $('#button_check').popover({}).hide();
        $('#button_check').show().html('Check');
        $('#button_convert').hide().html('Download');

        $('#success_div').hide();  
        $("#audio_div").hide(); 
        $("video").hide();
        $('#progress_div').hide(); 


        $('#convert_button').hide();     
        $('#download_button').hide();
    }

    function get_download_button(uid){
        $("#download_button").attr("href", $("#download_button").attr("href") + uid);
        $("#download_button").show();

        $("#convert_button").hide();
        
        $("#success_div").show("fade-in");
        $('#progress_div').hide(); 
    }


    function get_convert_button(uid){
        $("#convert_button").attr("href", $("#convert_button").attr("href") + uid);
        $("#convert_button").show();

        $("#download_button").hide();

        $("#success_div").show("fade-in");
        $('#progress_div').hide(); 
    }


    function get_video_player(url){
        $('#audio_div').show();
        $('#video_player source').attr('src', url);
    }

    function get_progress(progress_url) {
        $('#success_div').hide(); 
        $('#progress_div').show(); 

        var my_timer = setInterval(function() {
            $.get( progress_url, function( progress_data ) {
                var progress_percent = parseInt(progress_data.dl_progress)
                javascript: console.log("[DONE] progress: " + progress_percent + "%");
                $(".progress-bar").animate({ width: progress_percent+'%'}, 1);

                if (parseInt(progress_percent) >= 100){
                    javascript: console.log("Clearing interval...");
                    clearInterval(my_timer);
                    get_download_button(progress_data.uid);
                }
            })
            .fail( function (data) {
                $('#button_check').show().html('Check');
                javascript: console.log("Failed to update download progress: " + data)
                message_html = "<div class='alert alert-danger'><h2>Failed to update download progress bar.</h2></div>";
                $('#message_div').html(message_html);
            });
        }, 5000);  
    }

    $("#convert_button").click(function(ev) {
        ev.preventDefault();
        var dl_url = $("#convert_button").attr("href")

        $.get( dl_url, function( dl_data ) {
            get_progress(dl_data);
        }).fail( function (data) {
            $('#button_check').show().html('Check');
            javascript: console.log("Failed to convert video: " + data)
            message_html = "<div class='alert alert-danger'><h2>Failed to convert video.</h2></div>";
            $('#message_div').html(message_html);
        });
        return false;
    });

    $("#button_check").click(function(ev) { // catch the form's submit event
        ev.preventDefault();
        // $('#message_div').html("");  
        $('#button_check').html('<i class="icon-spinner icon-spin icon-large icon-1x"></i>');

        var target = "{{ url_for('check') }}"
        $.ajax({ // create an AJAX call...
            data: $('#download_form').serialize(), // get the form data
            type: $('#download_form').attr("method"),
            url: target
        }, "json")
        .done(function(data) {
            $('#button_check').show().html('Check');
            javascript: console.log("[DONE] Sucess getting video info: " + data.url);
            javascript: console.log("[DONE] Video ext: " + data.ext);
            javascript: console.log("[DONE] Video uid: " + data.uid);
            javascript: console.log("[DONE] Video uid: " + "<a href='{{ url_for('convert', uid='') }}'" + data.uid);

            get_convert_button(data.uid);
            get_video_player(data.url);
            // $("#success_div").html("")
            // $("#success_div").append(dl_link);
            // $("#download_button").attr("href", $("#download_button").attr("href") + data.uid);
            // $("#success_div").show("fade-in");
            // $('#button_check').show().html('Check');
            // $('#button_convert').html("Download"); 
        })
        .fail( function (data) {
            $('#button_check').show().html('Check');
            javascript: console.log("Failed to get video info: " + data)
            $('#button_convert').html("Download"); 
            message_html = "<div class='alert alert-danger'><h2>Failed to fetch video info.</h2></div>";
            $('#message_div').html(message_html);
        });  
        return false;
    });

    $("#input_box").bind('change paste keyup', function() {
        get_initial_state();
    });

    // Main code run when the document is ready
    $(document).ready(function() {
        get_initial_state();
        // var counter = 1;
        // setInterval(function() {
        //        $(".progress-bar").animate({ width: counter+'%'}, 1);
        //     counter = counter + 1
        // }, 1000);
    });
</script>
{% endblock scripts %}

